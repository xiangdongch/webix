<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Webix Admin</title>
    <script type="text/javascript" src="webix/lodash.js"></script>
    <!-- Webix Library -->
    <script>
        window.permissions = ["aaaa"];
        window.webix_view = {
            $init: function (config) {
                this.callEvent && this._evs_events && this.callEvent("test", []);
            },
            permission_setter: function(permission) {
                if(permissions.indexOf(permission) == -1){
//                    this.hide();
                    this.disable();
                }else{
                    this.show();
                }
                return permission;
            },
            customUrl_setter: function (value) {
                if (value) {

                    if (value.url && value.autoload !== false) {
                        this.define("url", value.url);
                    }

                    if (value.dataFeed) {
                        this.define("dataFeed", value.dataFeed);
                    }

                    if (value.datatype) {
                        if (typeof (value.datatype) === "object") {
                            var datatype = "temp_" + webix.uid();
                            webix.DataDriver[datatype] = value.datatype;
                            value.datatype = datatype;

                            this.attachEvent("onDestruct", function () {
                                value.datatype = webix.copy(webix.DataDriver[datatype]);
                                delete webix.DataDriver[datatype];
                            });
                        }
                        this.define("datatype", value.datatype);
                        if (this.data) {
                            this.data.driver = webix.DataDriver[value.datatype];
                        }
                    }
                }
                return value;
            }
        }
        function msgBox(msg){
            webix.message({type: 'alert', text: '<div style="padding: 0 16px">' + msg + '</div>' });
        }
        var DEFAULT_PADDING = 20;
    </script>
    <script type="text/javascript" src="webix_new/webix.js"></script>
    <script type="text/javascript" src="webix_new/skin.js"></script>
    <!--<script type="text/javascript" src="webix/webix_debug.js"></script>-->
    <link rel="stylesheet" href="webix_new/webix.css">
    <link rel="stylesheet/less" href="assets/theme.siberia.less">

    <!-- The app's logic -->
    <script type="text/javascript" data-main="app" src="libs/require.js"></script>
    <script type="text/javascript">
        require.config({
            paths: {text: "libs/text"}
        });
        webix.i18n.parseFormat = "%m.%d.%Y";
        webix.i18n.setLocale();
        webix.DataDriver.customJson = webix.extend({
            toObject: function (_data) {
                var data = webix.DataDriver.json.toObject(_data);
                return data;
            },
            getRecords: function (_data) {
                var data = _data;
                if (data.result) {
                    data = data.result;
                }
                if (data && !webix.isArray(data)) return [data];
                return data;
            },
            getDetails: function (data) {
                return data;
            },
            getInfo: function (data) {
                var pageInfo = data.pageVO;

                var _info = {};
                if (!pageInfo) {
                    _info = {
                        config: data.config
                    };
                } else {
                    var count = pageInfo.totalRows;
                    var hasMore = false;
                    _info = {
                        total_count: count,
                        pos: pageInfo.pageSize * (pageInfo.curPage - 1),
                        parent: null,
                        config: data.config,
                        webix_security: null
                    };

                    if (hasMore) {
                        _info.config = {
                            hasMore: true
                        };
                    }
                }

                return webix.DataDriver.json.getInfo(_info);
            }
        }, webix.DataDriver.json);

        var customProxy = {
            $proxy:true,
            load:function(view, callback, details){
                const config = view.config;
                const customUrl = config.customUrl;
                const params = this.params || customUrl.params || {a: 1};
                const httpMethod = customUrl.httpMethod || 'GET';
                const timeout = customUrl.timeout || 60000;
                const headers = customUrl.headers || {};

                const from = view.count();
                const count = config.datafetch || view.count();
                const curPage = Math.floor(from / count) + 1;
                const totalRows = -1;
                const pageSize = count;

                var url = this.source;
                url = url.replace("{curPage}", curPage.toString())
                    .replace("{pageSize}", pageSize.toString())
                    .replace("{totalRows}", totalRows.toString());

                var paramsJson = JSON.stringify(params);
                if(httpMethod === 'get'){
                    if (!!window.ActiveXObject || "ActiveXObject" in window) {
                        var key = "date" + new Date().getTime();
                        params[key] = key;
                    }
                    if (typeof (params) == 'object' && Object.keys(params).length === 0) {
                        paramsJson = "";
                    }
                    paramsJson = '';
                }
                var mycallback = [{
                    error: function(text, data, loader) {
                        msgBox('数据加载异常，状态码：' + loader.status);
                        view.callEvent("onAfterLoad", []);
                    },
                    success: function(text, data, loader) {
                        webix.ajax.$callback(view, callback, text, data, loader);
                    }
                }];
                headers['Content-Type'] = 'application/json';
                webix.ajax().headers(headers).timeout(timeout)[httpMethod](url, paramsJson, mycallback, this);
            },
            save:function(view, update, dp, callback){
                webix.ajax().post(url, update, callback);
            },
            result:function(state, view, dp, text, data, loader){
                dp.processResult(state, data, details);
            }
        };
        webix.proxy.customProxy = webix.extend(webix.proxy, {
            customProxy: customProxy
        }).customProxy;

    </script>

    <!-- Development only -->
    <script type="text/javascript" src="libs/less.min.js"></script>
</head>
<body></body>
</html>